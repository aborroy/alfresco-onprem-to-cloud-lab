upstream alfresco_backend {
  server alfresco:8080;
  keepalive 32;
}

server {
  listen 8080;
  server_name _;
  return 301 https://$host:8443$request_uri;
}

server {
  listen 8443 ssl http2;
  server_name _;

  ssl_certificate /etc/nginx/ssl/alfresco.crt;
  ssl_certificate_key /etc/nginx/ssl/alfresco.key;

  ssl_protocols TLSv1.3;
  ssl_prefer_server_ciphers off;
  ssl_session_timeout 1d;
  ssl_session_cache shared:SSL:50m;
  ssl_session_tickets off;

  add_header Strict-Transport-Security "max-age=63072000" always;
  add_header X-Frame-Options DENY;
  add_header X-Content-Type-Options nosniff;
  add_header X-XSS-Protection "1; mode=block";

  client_max_body_size 0;

  proxy_connect_timeout 300;
  proxy_send_timeout 300;
  proxy_read_timeout 300;
  send_timeout 300;

  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto https;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-Port 8443;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_buffering off;

  location = / {
    return 302 /workspace;
  }

  location /alfresco {
    proxy_pass http://alfresco_backend;
  }

  location /workspace {
    proxy_pass http://digital-workspace:8080;
  }

  location /share {
    proxy_pass http://share:8080;
  }

  location /webdav {
    proxy_pass http://alfresco_backend;
  }
}
